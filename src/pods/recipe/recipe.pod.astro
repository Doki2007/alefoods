---
import ClockIcon from "#assets/icons/ClockIcon.astro";
import DifficultyIcon from "#assets/icons/DifficultyIcon.astro";
import PortionIcon from "#assets/icons/PortionIcon.astro";
import ShareIcon from "#assets/icons/ShareIcon.astro";
import StarIcon from "#assets/icons/StarIcon.astro";
import type { Recipe } from "#pods/recipe-collection/recipe-collection.model.ts";

interface Props {
  recipeEntry: Recipe;
}

const { recipeEntry } = Astro.props;

const siteUrl = Astro.site ? Astro.site.toString() : "https://www.alefoods.pe";
const recipeSchema = {
  "@context": "https://schema.org",
  "@type": "Recipe",
  name: recipeEntry.title,
  image: [new URL(recipeEntry.image.url, siteUrl).toString()],
  description: recipeEntry.description,
  prepTime: `PT${recipeEntry.prepTime}M`,
  recipeYield: `${recipeEntry.serving} servings`,
  author: { "@type": "Organization", name: "Alefoods" },
  recipeIngredient: recipeEntry.ingredientCollection,
  recipeInstructions: recipeEntry.instruction
    .split("\n")
    .filter((s) => s.trim())
    .map((step) => ({
      "@type": "HowToStep",
      text: step.trim(),
    })),
};
---

<script type="application/ld+json" set:html={JSON.stringify(recipeSchema)} />

<section class="max-w-6xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8">
  <div class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
    <span><a href="/recipes" class="hover:underline">Recipes</a></span> / <span
      class="truncate">{recipeEntry.title}</span
    >
  </div>

  <div
    class="flex flex-col lg:flex-row gap-4 sm:gap-6 md:gap-8 mb-6 sm:mb-8 md:mb-10"
  >
    <!-- Left: Title, Description, Buttons -->
    <div class="w-full lg:basis-1/2 lg:self-end">
      <h1
        class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold mb-3 sm:mb-4"
      >
        {recipeEntry.title}
      </h1>
      <p
        class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-6 leading-relaxed"
      >
        {recipeEntry.description}
      </p>

      <!-- Action Buttons -->
      <div
        class="flex flex-col justify-start sm:flex-row gap-2 sm:gap-3 mb-6 sm:mb-8"
      >
        <button
          id="copy-link-btn"
          class="bg-white border border-gray-300 text-gray-700 px-4 sm:px-5 md:px-6 py-2 sm:py-2.5 md:py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors text-sm sm:text-base cursor-pointer"
        >
          <ShareIcon class={"size-4 sm:size-5"} />
          <span class="copy-link-btn-text">Copy Link</span>
        </button>
      </div>
    </div>

    <!-- Right: Recipe Image with Rating -->
    <div class="w-full lg:w-[450px] lg:shrink-0 lg:ml-auto">
      {
        recipeEntry.image && (
          <div class="relative">
            <img
              src={recipeEntry.image.url}
              alt={recipeEntry.image.name}
              class="w-full h-auto  rounded-lg object-cover"
            />
            <div class="absolute top-2 right-2 sm:top-4 sm:right-4 bg-white/90 backdrop-blur-sm px-2 py-1 sm:px-4 sm:py-2 rounded-lg shadow-lg">
              <div class="flex items-center gap-1">
                <span class="text-yellow-500 font-bold text-xs sm:text-sm">
                  4.9
                </span>
                <div class="flex text-yellow-500">
                  <StarIcon class={"size-3 sm:size-4"} />
                </div>
                <span class="text-xs sm:text-sm text-gray-600 hidden sm:inline">
                  (128 reviews)
                </span>
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>

  <div class="flex flex-col lg:flex-row gap-4 sm:gap-8 md:gap-12">
    <div class="w-full mx-auto lg:flex lg:basis-1/4">
      <div
        class="bg-[#FFE2E2] rounded-xl sm:rounded-2xl p-4 sm:p-5 md:p-6 h-fit w-full max-w-sm mx-auto sm:w-fit sm:max-w-none sm:mx-0"
      >
        <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4">Ingredients:</h2>
        <ul class="space-y-2 sm:space-y-3 mb-4 sm:mb-6">
          {
            recipeEntry.ingredientCollection.map((ingredient) => (
              <li class="ingredient-item flex items-start gap-2 sm:gap-3">
                <input
                  type="checkbox"
                  name="ingredient"
                  class="checkbox mt-1 w-4 h-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500 shrink-0"
                />
                <span class="ingredient-name text-gray-800 text-sm sm:text-base">
                  {ingredient}
                </span>
              </li>
            ))
          }
        </ul>
      </div>
    </div>

    <div class="w-full lg:flex-1">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-6 sm:mb-8 md:mb-10"
      >
        <div class="bg-teal-50 p-3 sm:p-4 rounded-lg items-center text-center">
          <div class="flex items-center gap-1 sm:gap-2 mb-1 justify-center">
            <ClockIcon class={"size-4 sm:size-5 text-teal-600"} />

            <span
              class="font-semibold text-gray-800 text-xs sm:text-sm md:text-base"
              >Preparation</span
            >
          </div>
          <p class="text-gray-600 text-sm sm:text-base">
            {recipeEntry.prepTime} min
          </p>
        </div>

        <div class="bg-teal-50 p-3 sm:p-4 rounded-lg items-center text-center">
          <div class="flex items-center gap-1 sm:gap-2 mb-1 justify-center">
            <DifficultyIcon class={"size-4 sm:size-5 text-teal-600"} />
            <span
              class="font-semibold text-gray-800 text-xs sm:text-sm md:text-base"
              >Difficulty</span
            >
          </div>
          <p class="text-gray-600 text-sm sm:text-base">
            {recipeEntry.difficulty}
          </p>
        </div>
        <div class="bg-teal-50 p-3 sm:p-4 rounded-lg items-center text-center">
          <div class="flex items-center gap-1 sm:gap-2 mb-1 justify-center">
            <PortionIcon class={"size-4 sm:size-5 text-teal-600"} />
            <span
              class="font-semibold text-gray-800 text-xs sm:text-sm md:text-base"
              >Portions</span
            >
          </div>
          <p class="text-gray-600 text-sm sm:text-base">
            {recipeEntry.serving} pers
          </p>
        </div>
      </div>
      <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Instructions</h2>
      <div class="space-y-4 sm:space-y-5 md:space-y-6 mb-8 md:mb-10">
        {
          recipeEntry.instruction
            .split("\n")
            .filter((step) => step.trim())
            .map((step, index) => (
              <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-5 shadow-sm">
                <div class="flex items-start gap-3 sm:gap-4">
                  <div class="shrink-0 w-7 h-7 sm:w-8 sm:h-8 bg-teal-600 text-white rounded-full flex items-center justify-center font-bold text-sm sm:text-base">
                    {index + 1}
                  </div>
                  <div class="flex-1">
                    <p class="text-gray-800 leading-relaxed text-sm sm:text-base">
                      {step.trim()}
                    </p>
                  </div>
                </div>
              </div>
            ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  function copyLink() {
    const copyLinkBtn = document.getElementById(
      "copy-link-btn",
    ) as HTMLButtonElement;
    const copyLinkBtnText = document.querySelector(
      ".copy-link-btn-text",
    ) as HTMLElement;

    if (!copyLinkBtn) return;

    const originalButton = copyLinkBtnText.textContent || "Copy Link";

    copyLinkBtn.addEventListener("click", () => {
      const url = window.location.href;
      navigator.clipboard.writeText(url);

      copyLinkBtnText.textContent = "Link copied!";

      setTimeout(() => {
        copyLinkBtnText.textContent = originalButton;
      }, 2000);
    });
  }

  function handleIngredients() {
    const ingredients = document.querySelectorAll(".ingredient-item");

    ingredients.forEach((item) => {
      const cb = item.querySelector(".checkbox") as HTMLInputElement;
      const name = item.querySelector(".ingredient-name") as HTMLElement;

      cb.addEventListener("change", () => {
        name.classList.toggle("line-through", cb.checked);
      });
    });
  }

  copyLink();
  handleIngredients();
  document.addEventListener("astro:page-load", copyLink);
  document.addEventListener("astro:page-load", handleIngredients);
</script>
