---
import WhatsappIcon from "#assets/icons/WhatsappIcon.astro";
import ChevronIcon from "#assets/icons/ChevronIcon.astro";
import type { Product } from "#pods/products-collection/products-collection.model.ts";

interface Props {
  productEntry: Product;
}

const { productEntry } = Astro.props;

const siteUrl = Astro.site ? Astro.site.toString() : "https://www.alefoods.pe";

const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  name: productEntry.title,
  image: productEntry.picture.map((pic) =>
    new URL(pic.url, siteUrl).toString(),
  ),
  description: productEntry.shortDescription || productEntry.description,
  sku: productEntry.id,
  brand: {
    "@type": "Brand",
    name: "Alefoods",
  },
  offers: {
    "@type": "Offer",
    url: new URL(Astro.url.pathname, siteUrl).toString(),
    priceCurrency: "PEN",
    price: productEntry.price,
    availability:
      productEntry.inStock !== false
        ? "https://schema.org/InStock"
        : "https://schema.org/OutOfStock",
    itemCondition: "https://schema.org/NewCondition",
  },
};
---

<script type="application/ld+json" set:html={JSON.stringify(productSchema)} />

<section
  class="min-h-dvh max-w-7xl mx-auto flex flex-col px-4 sm:px-6 md:px-8 py-6 sm:py-8 md:py-10"
>
  <div class="flex flex-col lg:flex-row gap-6 sm:gap-8 md:gap-10 lg:gap-12">
    <div class="w-full lg:basis-lg lg:max-w-lg">
      <!-- main foto 1/2 -->
      <div class="gallery-container justify-items-center overflow-hidden">
        <div class="main-image rounded-xl">
          <img
            id="big-image"
            src={productEntry.picture[0].url}
            alt={productEntry.picture[0].name}
            class="w-full h-auto object-cover aspect-square rounded-4xl sm:aspect-4/3 md:aspect-square"
          />
        </div>
        <!-- fotos pequeñas debajo de la main 3-4 -->
        <div
          class="thumbnails flex justify-between gap-2 sm:gap-3 md:gap-4 p-2 sm:p-3"
        >
          {
            productEntry.picture.map((picture) => (
              <img
                src={picture.url}
                alt={picture.name}
                class="mini w-full h-20 sm:h-24 md:h-28 lg:h-32 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
              />
            ))
          }
        </div>
      </div>
    </div>

    <div class="flex-1 w-full lg:px-8 space-y-6 sm:space-y-8">
      <div class="space-y-4 sm:space-y-6 mb-12 sm:mb-16 md:mb-24">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold">
          {productEntry.title}
        </h1>
        <p class="text-sm sm:text-base md:text-md">
          {productEntry.description}
        </p>
        <div class="flex flex-wrap items-center gap-3 sm:gap-4 md:gap-5">
          <span class="text-2xl sm:text-3xl font-bold"
            >S/ {productEntry.price}.00</span
          >
          <!-- <span
            class="line-through text-gray-400 text-lg sm:text-xl md:text-2xl"
            >S/ {productEntry.price}.00</span
          >
          <span
            class="text-xs sm:text-sm bg-green-300 text-green-700 px-2 py-1 rounded"
            >-18%</span
          > -->
        </div>

        <div
          class="flex flex-col sm:flex-row items-center justify-between gap-4 sm:gap-6"
        >
          <div
            class="qty-container flex items-center justify-between bg-gray-200 rounded-3xl gap-3 w-full sm:w-auto"
          >
            <span
              data-action="decrease"
              class="qty-btn border border-gray-300 px-3 py-1 sm:px-4 sm:py-2 bg-white rounded-full items-center hover:bg-gray-50 transition-colors cursor-pointer select-none"
              >-</span
            >
            <span class="quantity text-center select-none">1</span>
            <span
              data-action="increase"
              class="qty-btn border border-gray-300 px-3 py-1 sm:px-4 sm:py-2 bg-white rounded-full items-center hover:bg-gray-50 transition-colors cursor-pointer select-none"
              >+</span
            >
          </div>

          <button
            id="whatsapp-btn"
            data-product-title={productEntry.title}
            class="flex-1 sm:flex-initial w-full sm:w-auto border-2 border-green-600 rounded-full bg-green-600 text-black py-2.5 sm:py-3 px-6 hover:bg-green-500 hover:border-green-600 hover:text-white transition-all duration-300 ease-in-out cursor-pointer font-semibold"
          >
            <div class="flex justify-center items-center gap-2">
              <WhatsappIcon class={"size-7"} />
              <span class="text-sm sm:text-base font-semibold">Shop Now</span>
            </div>
          </button>
        </div>
      </div>

      <div
        class="accordion w-full max-w-2xl mx-auto p-4 sm:p-6 bg-gray-300/30 rounded-2xl sm:rounded-3xl border border-gray-300/50"
      >
        <div
          class="accordion-header flex justify-between items-center mb-4 border-b pb-2 cursor-pointer"
        >
          <h2 class="text-base sm:text-lg font-bold text-gray-800 pr-2">
            Nutritional Information (per 100g)
          </h2>
          <ChevronIcon class={"chevron size-5 shrink-0"} />
        </div>

        <div
          class="accordion-content hidden grid-cols-1 sm:grid-cols-2 gap-x-8 sm:gap-x-12 md:gap-x-16 gap-y-2"
        >
          <div class="flex flex-col gap-2">
            {
              productEntry.nutritionInfo.map((nutrition) => (
                <div class="flex justify-between border-b border-dotted border-gray-300 pb-1">
                  <span class="text-sm sm:text-base text-gray-500">
                    {nutrition.label}
                  </span>
                  <span class="text-sm sm:text-base font-medium">
                    {nutrition.value}
                  </span>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <div
        class="accordion w-full max-w-2xl mx-auto p-4 sm:p-6 bg-gray-300/30 rounded-2xl sm:rounded-3xl border border-gray-300/50"
      >
        <div
          class="accordion-header flex justify-between items-center mb-4 border-b pb-2 cursor-pointer"
        >
          <h2 class="text-base sm:text-lg font-bold text-gray-800 pr-2">
            Benefits
          </h2>
          <svg
            class="chevron size-5 shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            >
            </path>
          </svg>
        </div>

        <div
          class="accordion-content hidden grid-cols-1 sm:grid-cols-2 gap-x-8 sm:gap-x-12 md:gap-x-16 gap-y-2 auto-rows-min"
        >
          {
            productEntry.feature.map((feat) => {
              return (
                <div class="flex justify-between border-b border-dotted border-gray-300 pb-1">
                  <span class="text-sm sm:text-base text-gray-500">{feat}</span>
                </div>
              );
            })
          }
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function initProductGallery() {
    const container = document.querySelector(".gallery-container");
    const bigImage = document.getElementById("big-image") as HTMLImageElement;
    const thumbnails = document.querySelectorAll(".mini");
    const accordions = document.querySelectorAll(".accordion");
    const quantityEl = document.querySelector(".quantity");
    const qtyContainer = document.querySelector(".qty-container");
    let quantity = 1;

    const whatsappBtn = document.getElementById("whatsapp-btn");

    if (!container || !bigImage) return;

    thumbnails[0]?.classList.add("ring-2", "ring-green-500", "opacity-100");

    container.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;

      // Verificamos si lo que se clickeó es una miniatura
      if (target.classList.contains("mini")) {
        const mini = target as HTMLImageElement;

        // Cambiamos la imagen grande
        bigImage.src = mini.src;
        bigImage.alt = mini.alt;

        // Feedback visual: quitamos el anillo a todas y se lo damos a la elegida
        thumbnails.forEach((t) =>
          t.classList.remove("ring-2", "ring-green-500", "opacity-100"),
        );
        mini.classList.add("ring-2", "ring-green-500", "opacity-100");
        // Opcional: una pequeña animación de entrada
        bigImage.animate([{ opacity: 0.5 }, { opacity: 1 }], { duration: 250 });
      }
    });

    accordions.forEach((accordion) => {
      const header = accordion.querySelector(".accordion-header");
      const content = accordion.querySelector(".accordion-content");
      const chevron = accordion.querySelector(".chevron");

      header?.addEventListener("click", () => {
        const isOpen = !content?.classList.contains("hidden");

        if (isOpen) {
          content?.classList.add("hidden");
          content?.classList.remove("grid");
          chevron?.classList.remove("rotate-180");
        } else {
          content?.classList.remove("hidden");
          content?.classList.add("grid");
          chevron?.classList.add("rotate-180");
        }
      });
    });

    qtyContainer?.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;

      if (!target.classList.contains("qty-btn")) return;

      const action = target.dataset.action;

      if (action === "increase") quantity++;
      if (action === "decrease" && quantity > 1) quantity--;

      quantityEl!.textContent = quantity.toString();
    });

    whatsappBtn?.addEventListener("click", () => {
      const phone = "51932120023";
      const productName =
        whatsappBtn.getAttribute("data-product-title") ?? "el producto";
      const message = `Buen día! Me gustaría comprar ${quantity} unidad(es) de ${productName}.`;

      const encodedMessage = encodeURIComponent(message);

      const url = `https://wa.me/${phone}?text=${encodedMessage}`;

      window.open(url, "_blank");
    });
  }

  document.addEventListener("astro:page-load", initProductGallery);
</script>
